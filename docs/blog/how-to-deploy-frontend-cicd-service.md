---
layout: doc
sidebar: false
aside: true
titleTemplate: true
title: 从零开始搭建前端 CI/CD 环境
description: 搭建一套服务于前端环境的 CI/CD 系统，优雅的部署测试环境的前端服务
head:
  - - meta
    - name: keywords
      content: cicd, 前端, 自动构建
outline: 2
---

# 从零开始搭建前端 CI/CD 环境

在进行开发的时候，经常会需要部署测试环境的问题。然而部署测试环境并没有那么简单：首先得需要编译源码、其次得通过一个方式上传到测试机（或者直接在测试机上编译）；之后得在测试机启动（或者重启）服务；如果没有配置过 Nginx 访问，还需要配置下 Nginx。而且面对多人同时开发的时候，经常也会遇到测试环境抢占的问题、当然给自己单独部署一个测试环境也是可以的，但是总会有需要同时部署多个 feature 的情况。

本文旨在探讨，如何利用现有开源组件快速的构建一个前端测试环境 CI/CD 的系统。

## 什么是 CI/CD?
*CI/CD or CICD generally refers to the combined practices of continuous integration and either continuous delivery or continuous deployment*

## 搭建一套自动构建的环境
自动部署的前提是得有一套可以部署的产物，而对于前端来说，项目类型的不同也决定这项目的产物。例如对于 SPA 的项目，编译产物可以只是一系列的静态文件（入口 HTML、JS 以及 CSS）；对于含有 Node 层的项目，编译产物就稍微复杂一点：可以是包含所有代码和 node_modules 依赖的 tar 包（当然前提是，编译环境和运行环境得是一样的，一些模块可能依赖特定的 node 版本甚至系统库的版本），或者一个包含所有运行需要的依赖的 docker image。

而产物的自动构建，对于自动部署的也同样重要。如果是在本地构建然后分发，不仅仅占用本机的性能，还会打断自己编码的节奏。所以最好的方式，还是和线上保持统一，采用 Gitlab 作为统一的代码版本管理。当 Gitlab 收到新的代码 Push 时，自动触发构建，这个才是最好的形态。

如何触发自动构建呢？这个就不得不提到 Gitlab 的 Webhook 了。所谓 Webhook，是用户自定义的 HTTP 回调；当有相应的事件（比如 Git repo 有新的 Push 了）触发时，会自动调用这个接口通知用户。

所以现在做的就很简单了，在测试机上部署一个 HTTP 服务，这个 HTTP 可以监听 Gitlab 的 Webhook 回调，当有新的关注的 Push 事件时，触发一个构建，就像这样：

![Workflow](/assets/how-to-deploy-frontend-cicd-service/workflow.png)


这里使用了 Node.js 去开发这个 HTTP 服务，当有新的 Push 产生时，会触发一个编译脚本的执行。编译脚本分为两步：

1. 代码的拉取（拉取仓库的代码、并且切换到对应的分支）
2. 编译的执行（具体什么编译脚本，可以由用户自定义）

## 开始自动部署
相应的构建产物准备好了，下一步就是部署了。比如如果选择了 docker image 作为构建产物，可以通过 docker swarm 或者 k8s 进行部署，但是如果只是测试环境使用的话，未免也太过于大炮打蚊子。针对前端的这个环境，通过 PM2 来管理已经足够够用了。

为什么选用 PM2 进行管理呢？因为 PM2 相对轻量，不仅仅可以保障应用的自愈、还能做强大的进程管理，笔者在这里使用了两种模式进行服务的部署：

1. 如果是 SPA 项目，可以用 PM2 通过 [serve](https://www.npmjs.com/package/serve) 启动一个静态文件服务器  
2. 如果是 Node 项目，直接通过 PM2 启动其文件入口

并且还得考虑一下问题：

1. 不同服务之间可能得端口抢占的问题，所以得分配一个端口避免冲突
2. 服务可能依赖某些环境变量来指定参数

笔者这里在创建项目的时候，就会自动分配一个尚未使用的端口，并通过 PORT 这个环境变量传给用户的构建脚本。并且允许用户随时更改一些环境变量。

到这里为止，CICD 的大部分内容都已经结束了，我们已经构建了一个自动编译、部署到测试环境的工具。可以通过只推送代码，就完成代码的自动分发到测试机、自动构建（并且回传构建日志）、以及自动部署。当然，如果不想关注这些命令，只想快速部署线上服务的话，CNative 已经为您准备好了这么一套直接的 CICD 系统，实现推送代码即可线上访问